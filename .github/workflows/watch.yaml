name: Watch for changes

on:
    pull_request:
    schedule:
        - cron: '0 6 * * *'

jobs:
    generated-code:
        name: Update recipes
        runs-on: Ubuntu-20.04

        steps:
            - name: Set up PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: 8.1
                  coverage: none

            - name: Checkout code
              uses: actions/checkout@v2
              with:
                  ref: main

            - name: Install dependencies
              uses: ramsey/composer-install@v2

            - name: Regenerate code against last version
              run: vendor/bin/yaml-to-php https://github.com/symfony/recipes.git

            - name: Show changes
              run: git status

            - name: Check write access to repo
              run: |
                  token_login=$(curl -H "Authorization: Bearer ${token}" https://api.github.com/user | jq -r '.login')
                  echo token login is ${token_login}
                  echo $(curl  -H "Authorization: Bearer ${token}" https://api.github.com/repos/${repo}/collaborators/${token_login}/permission) > result
                  cat result | jq  '.permission == "admin" // .permission == "write"' > /dev/null || ( echo "Token does not have write access to ${repo}" >> ${GITHUB_STEP_SUMMARY}; exit 1)
                  curl -sS -f -I -H "Authorization: Bearer ${token}" https://api.github.com | grep 'x-oauth-scopes:' | grep 'repo' > /dev/null && exit 0 || echo "Token does not have repo scope on ${repo}" >> ${GITHUB_STEP_SUMMARY}
              env:
                  repo: symfony-php-recipes-bot/symfony-recipes-php
                  token: ${{ secrets.BOT_TOKEN}}

            - name: Create Pull Request
              uses: peter-evans/create-pull-request@v4
              with:
                  token: ${{ secrets.BOT_TOKEN }}
                  push-to-fork: symfony-php-recipes-bot/symfony-recipes-php
                  author: SymfonyPHPRecipes Bot <alexander+symfony-php-recipes-bot@sulu.io>
                  committer: SymfonyPHPRecipes Bot <alexander+symfony-php-recipes-bot@sulu.io>
                  commit-message: update recipes code
                  title: Update generated code $(date +'%Y-%m-%dT%H:%M:%S')
                  body: |
                      The Symfony Recipes changed with version ${{ steps.fetch_version.outputs.last }}.
                      This PR contains the new definition for recipes.
                  branch: bot-code-update
